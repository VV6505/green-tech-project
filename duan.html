<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Hệ Thống Quản Lý Dự Án</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            background-image: url('https://i.postimg.cc/8PZ8kwnH/Logo1.jpg'); /* Đường dẫn đến hình ảnh */
            background-repeat: no-repeat; /* Không lặp lại hình ảnh */
            background-size: cover; /* Hình ảnh sẽ bao phủ toàn bộ khu vực */
            color: #2d3748;
            font-size: 16px;
        }

        /* Header */
        .header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 70px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-section h2 {
            font-size: 32px;
            font-weight: bolder;
            color: #1d5923;
            font-family: cursive;
        }

        .logo {
            width: 50px;
            height: 46px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .search-section {
            flex: 1;
            max-width: 500px;
            margin: 0 30px;
            position: relative;
        }

        .search-filters {
            position: absolute;
            top: 110%;
            left: 0;
            background: #cff0d9;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            padding: 10px 12px;
            display: none;
            z-index: 1100;
            width: 320px;
            font-size: 16px;
            
        }
        .search-section:hover .search-filters,
        .search-section:focus-within .search-filters { display: block; }
        .search-section.open .search-filters { display: block; }
        .search-filters label { display:flex; align-items:center; gap:8px; font-size:14px; color:#222731; margin:6px 0; }
        .search-filters .hint { font-size: 12px; color:#718096; margin-bottom: 6px; }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            background: #f7fafc;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-family: cursive;
            font-size: 20px;
        }

        .admin-avatar {
            width: 35px;
            height: 35px;
            background: #2b7433;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .settings-btn {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .settings-btn:hover {
            background: #e2e8f0;
        }

        .logout-btn {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            color: #b91c1c;
            margin-left: 10px;
        }
        .logout-btn:hover { background: #fef2f2; }

        /* Settings dropdown */
        .settings-wrapper { position: relative; display: inline-block; }
        .settings-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: #cff0d9;
            border: 1px solid #e2e8f0;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            border-radius: 10px;
            padding: 8px;
            display: none;
            z-index: 1200;
            min-width: 210px;
        }
        .settings-wrapper:hover .settings-menu { display: block; }
        .settings-wrapper.open .settings-menu { display: block; }
        .settings-menu button {
            width: 100%;
            background: transparent;
            border: none;
            text-align: left;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: #2d3748;
            font-size: 16px;
        }
        .settings-menu button:hover { background: #f7fafc; }

        /* Trash button */
        .trash-btn {
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all .2s ease;
        }
        .trash-btn:hover { background:#f7fafc; }
        .badge { background:#f56565; color:#fff; padding:2px 6px; border-radius:9999px; font-size:12px; margin-left:4px; }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 70px;
            width: 280px;
            height: calc(100vh - 70px);
            background: linear-gradient(135deg, #a7c58f 0%, #a7c58f 100%);
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            padding: 20px 0;
            overflow-y: auto;
            font-size: 17px;
        }

        .nav-item {
            padding: 12px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #4a5568;
            font-weight: 500;
        }

        .nav-item:hover {
            background: #f7fafc;
            color: #667eea;
        }

        .nav-item.active {
            background: #eef2ff;
            color: #667eea;
            border-right: 3px solid #667eea;
        }

        .nav-icon {
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            margin-top: 70px;
            padding: 30px;
            min-height: calc(100vh - 70px);
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #080a0e;
            font-size: 16px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            color: #718096;
            font-size: 18px;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 24px;
        }

        .stat-value {
            font-size: 35px;
            font-weight: bold;
            color: #2d3748;
        }

        /* Styling đặc biệt cho card Tổng Chi Phí */
        .stat-value-with-unit {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-main-value {
            font-size: 35px;
            font-weight: bold;
            color: #2d3748;
            line-height: 1;
        }

        .stat-unit {
            font-size: 25px;
            font-weight: 700;
            color: #10b981;
            margin-top: 5px;
            letter-spacing: 0.5px;
        }

        .stat-change {
            font-size: 18px;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: #48bb78;
        }

        .stat-change.negative {
            color: #f56565;
        }

        /* Project Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .projects-section {
            background: rgb(229, 239, 234);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .view-all-btn {
            color: #667eea;
            text-decoration: none;
            font-size: 18px;
            font-weight: 500;
        }

        .project-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .project-item {
            padding: 20px;
            border: 1px solid #2d3748;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .project-item:hover {
            border-color: #4053a8;
            box-shadow: 0 4px 12px rgba(111, 136, 247, 0.1);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .project-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 18px;
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 500;
            margin-left: 10px;
        }

        .project-image {
            width: 100px;
            height: auto;
            border-radius: 10px;
            margin-left: 10px;
        }

        .project-progress {
            margin-top: 10px;
        }

        .progress-bar {
            height: 4px; /* Chiều cao của thanh tiến độ */
        }

        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-pending {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-completed {
            background: #bee3f8;
            color: #2a4365;
        }

        .project-progress {
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 16px;
            color: #636364;
            font-style: bold;
            margin-top: 5px;
        }

        /* Reusable button for "Xem chi tiết" with hover */
        .btn-detail {
            padding: 10px 16px;
            background: #ffffff;
            color: #2d3748;
            border: 2px solid #2d3748;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-detail:hover {
            background: #2d3748;
            color: #ffffff;
        }

        /* Date group: text + calendar picker button */
        .date-group { position: relative; }
        .date-group > input[type="text"] { padding-right: 40px; }
        .date-picker-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            color: #6b7280;
            border-radius: 6px;
            padding: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            line-height: 1;
            font-size: 18px;
        }
        .date-picker-btn:hover { background:rgba(16,185,129,.08); }
        .hidden-date { position:absolute; width:0; height:0; opacity:0; pointer-events:none; }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .goals-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .goal-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f7fafc;
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform .18s ease, box-shadow .18s ease;
        }
        .goal-item:hover { animation: goal-bump .35s ease; box-shadow: 0 6px 16px rgba(0,0,0,.08); }
        @keyframes goal-bump {
            0% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
            100% { transform: translateY(0); }
        }

        .goal-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .goal-description {
            font-size: 14px;
            color: #718096;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .header { height: 64px; padding: 12px 24px; }
            .sidebar { width: 240px; top: 64px; }
            .main-content { margin-left: 240px; margin-top: 64px; padding: 24px; }
            .page-title { font-size: 24px; }
            .section-title { font-size: 18px; }
            .nav-item { padding: 10px 24px; }
            .project-item { padding: 16px; }
            .project-name { font-size: 16px; }
            .project-status { font-size: 14px; }
            .project-image { width: 80px; }
            .stat-card { padding: 20px; }
            .stat-value, .stat-main-value { font-size: 30px; }
            .stat-unit { font-size: 20px; }
            .progress-text { font-size: 14px; }
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo"><img class="logo" src="https://i.postimg.cc/8PZ8kwnH/Logo1.jpg" alt="logo_CT"></div>
            <h2>Green Tech</h2>
        </div>
        
        
        <div class="search-section">
            <input type="text" class="search-input" placeholder="Nhập từ khóa tìm kiếm...">
            <button class="search-btn">🔍</button>
            <div class="search-filters" id="searchFilters">
                <div class="hint" style="color: #000000; font-weight: bold;">Lọc theo:</div>
                <label><input type="checkbox" id="sf_name" checked> Tên dự án</label>
                <label><input type="checkbox" id="sf_code" checked> Mã dự án</label>
                <label><input type="checkbox" id="sf_manager" checked> Người quản lý</label>
                <label><input type="checkbox" id="sf_start" checked> Ngày bắt đầu</label>
                <label><input type="checkbox" id="sf_status" checked> Trạng thái</label>
            </div>
        </div>
        
        <div class="user-section">
            <div class="admin-info" onclick="openUserInfo()">
                <div class="admin-avatar" id="userAvatar">U</div>
                <span id="userName">User</span>
            </div>
            <div class="settings-wrapper" id="settingsWrapper">
                <button class="settings-btn" onclick="toggleSettingsMenu(event)">⚙️ Cài đặt</button>
                <div class="settings-menu">
                    <button onclick="openEditChooser()">✏️ Chỉnh sửa dự án...</button>
                    <button onclick="openDeleteChooser()">🗑️ Xóa dự án...</button>
                    <button onclick="openApproveChooser()">✅ Duyệt dự án...</button>
                </div>
            </div>
            <button class="logout-btn" onclick="doLogout()">🚪 Đăng xuất</button>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="nav-item">
            <span class="nav-icon">🏠</span>
            <span>Trang chủ</span>
        </div>

        <div class="nav-item">
            <span class="nav-icon">📅</span>
            <span>Lịch làm việc</span>
        </div>
        <div class="nav-item active">
            <span class="nav-icon">📁</span>
            <span>Dự án</span>
        </div>
        <div class="nav-item">
            <span class="nav-icon">📋</span>
            <span>Công việc</span>
        </div>
        <div class="nav-item">
            <span class="nav-icon">💰</span>
            <span>Quản lý chi phí</span>
        </div>
        <div class="nav-item">
            <span class="nav-icon">📋</span>
            <span>Danh mục tài sản dự án</span>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">Tổng Quan</h1>
            <p class="page-subtitle">Xem tổng quan về tất cả dự án và hoạt động của công ty</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Tổng Dự Án</span>
                    <span class="stat-icon">📊</span>
                </div>
                <div class="stat-value">24</div>
                <div class="stat-change positive">+12% so với năm trước</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Dự Án Hoàn Thành</span>
                    <span class="stat-icon">✅</span>
                </div>
                <div class="stat-value">18</div>
                <div class="stat-change positive">+8% so với năm trước</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Đang Thực Hiện</span>
                    <span class="stat-icon">🔄</span>
                </div>
                <div class="stat-value">4</div>
                <div class="stat-change negative">-2% so với năm trước</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Tổng Chi Phí</span>
                    <span class="stat-icon">💵</span>
                </div>
                <div class="stat-value-with-unit">
                    <div class="stat-main-value">2.5</div>
                    <div class="stat-unit">TRIỆU USD</div>
                </div>
                <div class="stat-change positive">+15% so với năm trước</div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Projects Section -->
            <div class="projects-section">
                <div class="section-header">
                    <h3 class="section-title">Dự Án Gần Đây</h3>
                    <a href="#" class="view-all-btn" onclick="showAllProjects(event)">Xem tất cả →</a>
                </div>

                <div class="project-list">
                    <div class="project-item" data-project-id="duan1">
                        <div class="project-header">
                            <div class="project-name">
                                Dự án 1: Sân bay Long Thành
                                <div class="project-status status-active">Đang thực hiện</div>
                            </div>
                            <img src="https://cdn2.tuoitre.vn/thumb_w/730/471584752817336320/2025/6/25/hinh-anh-san-bay-long-thanh-phoi-canh-1750815065744231701004.jpg" alt="Sân bay Long Thành" class="project-image">
                        </div>
                        <div class="project-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 75%; height: 100%;"></div>
                            </div>
                            <div class="progress-text">Hoàn thành 75%</div>
                        </div>
                        <div style="margin-top: 12px; text-align: right;">
                            <button class="btn-detail" onclick="showProjectDetails('duan1')">🔎 Xem chi tiết</button>
                        </div>
                    </div>

                    <div class="project-item" data-project-id="duan2">
                        <div class="project-header">
                            <div class="project-name">
                                Dự án 2: Pin Lithium
                                <div class="project-status status-pending">Chờ phê duyệt</div>
                            </div>
                            <img src="https://img-s-msn-com.akamaized.net/tenant/amp/entityid/AA1u3OuV.img?w=768&h=576&m=6" alt="Pin Lithium" class="project-image">
                        </div>
                        <div class="project-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 10%; height: 100%;"></div>
                            </div>
                            <div class="progress-text" >Hoàn thành 10%</div>
                        </div>
                        <div style="margin-top: 12px; text-align: right;">
                            <button class="btn-detail" onclick="showProjectDetails('duan2')">🔎 Xem chi tiết</button>
                        </div>
                    </div>

                    <div class="project-item" data-project-id="duan3">
                        <div class="project-header">
                            <div class="project-name">
                                Dự án 3: Phần mềm PMIS
                                <div class="project-status status-completed">Đã hoàn thành</div>
                            </div>
                            <img src="https://pmis.lt/dev/Logo%201.png" alt="Phần mềm PMIS" class="project-image">
                        </div>
                        <div class="project-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 100%; height: 100%;"></div>
                            </div>
                            <div class="progress-text" >Hoàn thành 100%</div>
                        </div>
                        <div style="margin-top: 12px; text-align: right;">
                            <button class="btn-detail" onclick="showProjectDetails('duan3')">🔎 Xem chi tiết</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Goals Section -->
                <div class="goals-section">
                    <div class="section-header">
                        <h3 class="section-title">Mục Tiêu</h3>
                    </div>

                    <div class="goal-item">
                        <div class="goal-title">Hoàn thành 90% dự án trong Q3</div>
                        <div class="goal-description">Đạt được tỷ lệ hoàn thành cao nhất trong năm</div>
                    </div>

                    <div class="goal-item">
                        <div class="goal-title">Tối ưu hóa quy trình</div>
                        <div class="goal-description">Giảm 20% thời gian thực hiện dự án</div>
                    </div>

                    <div class="goal-item">
                        <div class="goal-title">Nâng cao chất lượng</div>
                        <div class="goal-description">Đảm bảo chất lượng đầu ra đạt tiêu chuẩn cao</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="goals-section">
                    <div class="section-header">
                        <h3 class="section-title">Thao Tác Nhanh</h3>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button style="
                            padding: 12px 20px;
                            background: #667eea;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 500;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#5a67d8'" onmouseout="this.style.background='#667eea'" onclick="showCreateProjectModal()">
                            + Tạo Dự Án Mới
                        </button>
                        
                        <button style="
                            padding: 12px 20px;
                            background: white;
                            color: #667eea;
                            border: 2px solid #667eea;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 500;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='white'" onclick="showYearlyReport()">
                            📊 Xem Báo Cáo
                        </button>
                        
                        <button style="
                            padding: 12px 20px;
                            background: white;
                            color: #48bb78;
                            border: 2px solid #48bb78;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 500;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#f0fff4'" onmouseout="this.style.background='white'">
                            💾 Xuất Dữ Liệu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Handle navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all items
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                // Add active class to clicked item
                this.classList.add('active');

                // Lấy icon của item được click
                const icon = this.querySelector('.nav-icon').textContent.trim();
                const itemText = this.querySelector('span:last-child').textContent.trim();
                
                // Hiển thị thông báo với icon + text
                showNotification(`Chuyển đến: ${icon} ${itemText}`);

                // Xử lý chuyển hướng dựa trên icon
                switch(icon) {
                    case '🏠':
                        console.log("Mở trang chủ trong tab mới...");
                        setTimeout(() => {
                            window.open('trangchu.html', '_blank', 'noopener');
                        }, 300);
                        break;
                    case '📁':
                        console.log("Mở trang dự án trong tab mới...");
                        setTimeout(() => {
                            if (!window.location.pathname.endsWith('duan.html')) {
                                window.open('duan.html', '_blank', 'noopener');
                            }
                        }, 300);
                        break;
                    case '📋':
                        showNotification('Trang đang được phát triển, vui lòng quay lại sau');
                        break;
                    case '💰':
                        showNotification('Trang đang được phát triển, vui lòng quay lại sau');
                        break;
                    case '📅':
                        showNotification('Trang đang được phát triển, vui lòng quay lại sau');
                        break;
                    default:
                        console.log("Chỉ hiển thị thông báo cho: " + itemText);
                }
            });
        });

        // Handle search with filters + keep filter open while interacting
        const searchSectionEl = document.querySelector('.search-section');
        const searchInputEl = document.querySelector('.search-input');
        const searchBtnEl = document.querySelector('.search-btn');
        const filtersEl = document.getElementById('searchFilters');

        // Open panel on focus/click
        function openFilters(){ searchSectionEl?.classList.add('open'); }
        function closeFilters(){ searchSectionEl?.classList.remove('open'); }

        searchInputEl.addEventListener('focus', openFilters);
        searchInputEl.addEventListener('click', openFilters);
        filtersEl.addEventListener('mouseenter', openFilters);
        filtersEl.addEventListener('mouseleave', (e)=>{
            // delay close to allow moving back to input/button
            setTimeout(()=>{ if (!searchSectionEl.matches(':hover') && !document.activeElement.classList.contains('search-input')) closeFilters(); }, 120);
        });

        // Close when clicking outside of the header area
        document.addEventListener('click', (e)=>{
            const within = searchSectionEl.contains(e.target);
            if (!within) closeFilters();
        });

        searchBtnEl.addEventListener('click', function() { performSearch(); closeFilters(); });

        searchInputEl.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { performSearch(); closeFilters(); }
        });

        function getSelectedSearchFilters(){
            const filters = {
                name: document.getElementById('sf_name')?.checked ?? true,
                code: document.getElementById('sf_code')?.checked ?? true,
                manager: document.getElementById('sf_manager')?.checked ?? true,
                start: document.getElementById('sf_start')?.checked ?? true,
                status: document.getElementById('sf_status')?.checked ?? true,
            };
            // Nếu tất cả đều false, mặc định chọn tất cả
            if (!filters.name && !filters.code && !filters.manager && !filters.start && !filters.status){
                filters.name = filters.code = filters.manager = filters.start = filters.status = true;
            }
            return filters;
        }

        function performSearch(){
            const raw = document.querySelector('.search-input').value || '';
            const term = raw.trim();
            if (!term){
                showNotification('Vui lòng nhập từ khóa tìm kiếm');
                return;
            }
            const filters = getSelectedSearchFilters();
            const termLower = term.toLowerCase();

            const dataMap = (typeof projectDetailsById !== 'undefined') ? projectDetailsById : {};
            const results = Object.entries(dataMap).filter(([id, p]) => {
                if (!p) return false;
                let matched = false;
                if (filters.name && typeof p.ten === 'string' && p.ten.toLowerCase().includes(termLower)) matched = true;
                if (filters.code && typeof p.ma === 'string' && p.ma.toLowerCase().includes(termLower)) matched = true;
                if (filters.manager && typeof p.quanLy === 'string' && p.quanLy.toLowerCase().includes(termLower)) matched = true;
                if (filters.start && typeof p.ngayBatDau === 'string'){
                    const iso = p.ngayBatDau.toLowerCase();
                    const formatted = formatDate(p.ngayBatDau).toLowerCase();
                    if (iso.includes(termLower) || formatted.includes(termLower)) matched = true;
                }
                if (filters.status && typeof p.trangThai === 'string' && p.trangThai.toLowerCase().includes(termLower)) matched = true;
                return matched;
            });

            if (!results.length){
                showNotification('Không tìm thấy dự án phù hợp');
                return;
            }
            showSearchResults(results, term, filters);
        }

        function showSearchResults(results, term, filters){
            const content = results.map(([id, p]) => {
                const statusClass = p.trangThai === 'Đã hoàn thành' ? 'status-completed' : (p.trangThai === 'Chờ phê duyệt' ? 'status-pending' : 'status-active');
                return `
                <div class="project-item" data-project-id="${id}" style="margin-bottom:12px;">
                    <div class="project-header">
                        <div class="project-name">
                            ${p.ten}
                            <div class="project-status ${statusClass}">${p.trangThai}</div>
                        </div>
                        ${p.image ? `<img src="${p.image}" alt="${p.ten}" class="project-image">` : ''}
                    </div>
                    <div style="font-size:14px; color:#718096; margin:6px 0 10px;">
                        Mã: <strong>${p.ma}</strong> • Quản lý: <strong>${p.quanLy}</strong> • Bắt đầu: <strong>${formatDate(p.ngayBatDau)}</strong>
                    </div>
                    <div class="project-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${Math.max(0, Math.min(100, p.tienDo))}%; height:100%;"></div>
                        </div>
                        <div class="progress-text">Hoàn thành ${Math.max(0, Math.min(100, p.tienDo))}%</div>
                    </div>
                    <div style="margin-top: 12px; text-align: right;">
                        <button class="btn-detail" onclick="showProjectDetails('${id}')">🔎 Xem chi tiết</button>
                    </div>
                </div>`;
            }).join('');

            const selectedLabels = [
                filters.name ? 'tên' : null,
                filters.code ? 'mã' : null,
                filters.manager ? 'người quản lý' : null,
                filters.start ? 'ngày bắt đầu' : null,
                filters.status ? 'trạng thái' : null,
            ].filter(Boolean).join(', ');

            const modal = `
                <div id="searchResultsModal" style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:3000; display:flex; align-items:center; justify-content:center;">
                    <div style="background:#fff; border-radius:16px; width:96%; max-width:1100px; max-height:88vh; overflow:auto; padding:24px; color:#2d3748;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <div>
                                <h3 style="margin:0;">Kết quả cho "${term}"</h3>
                                <div style="font-size:14px; color:#718096;">Lọc theo: ${selectedLabels}</div>
                            </div>
                            <button onclick="document.getElementById('searchResultsModal').remove()" style="padding:8px 12px; border:none; border-radius:8px; background:#667eea; color:#fff; cursor: pointer; font-size: 16px;">Đóng</button>
                        </div>
                        <div class="project-list" style="gap:16px;">
                            ${content}
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        // Show notification function
        function showNotification(message) {
            // Remove existing notifications
            const existingNotif = document.querySelector('.notification');
            if (existingNotif) {
                existingNotif.remove();
            }

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 90px;
                right: 30px;
                background: #667eea;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1001;
                animation: slideIn 0.3s ease;
                font-weight: 500;
            `;
            notification.textContent = message;

            // Add slide in animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(notification);

            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add some interactive features
        document.addEventListener('DOMContentLoaded', function() {
            // Animate stats on load
            setTimeout(() => {
                document.querySelectorAll('.stat-value, .stat-main-value').forEach((stat, index) => {
                    stat.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        stat.style.transform = 'scale(1)';
                    }, 200);
                }, index * 100);
            }, 500);

            // Add hover effects to project items
            document.querySelectorAll('.project-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateX(5px)';
                });
                
                item.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateX(0)';
                });
            });

            // Hide progress for pending projects on initial render and add note
            document.querySelectorAll('.project-item').forEach(card => {
                const statusEl = card.querySelector('.project-status');
                const progress = card.querySelector('.project-progress');
                if (statusEl && progress && statusEl.textContent.trim() === 'Chờ phê duyệt'){
                    progress.style.display = 'none';
                    addOrRemovePendingNote(card, true);
                }
            });

            // Load user info and role
            const userRaw = localStorage.getItem('gt_user');
            if (userRaw){
                try {
                    const user = JSON.parse(userRaw);
                    const nameEl = document.getElementById('userName');
                    const avatarEl = document.getElementById('userAvatar');
                    if (nameEl) nameEl.textContent = user.name || user.email || 'User';
                    if (avatarEl) avatarEl.textContent = (user.name||user.email||'U').charAt(0).toUpperCase();
                    window.__currentRole = user.role || 'guest';
                    window.__currentUserName = user.name || user.email || 'User';
                } catch {}
            }

                    // Apply permissions to UI and visible projects
        applyRolePermissions();

        // Khởi tạo kho lịch sử ảo từ localStorage
        try {
            window.__audit = JSON.parse(localStorage.getItem('gt_audit') || '[]');
            if (!Array.isArray(window.__audit)) window.__audit = [];
        } catch { window.__audit = []; }

        // Tự động cập nhật trạng thái dự án dựa trên lịch sử duyệt
        updateProjectStatusFromAudit();
    });

        function addOrRemovePendingNote(card, isPending){
            if (!card) return;
            const existing = card.querySelector('.pending-note');
            if (isPending){
                if (!existing){
                    const noteHtml = `<div class="pending-note" style="margin:8px 0 0; padding:8px 12px; background:#fff7ed; color:#b45309; border:1px solid #fde68a; border-radius:8px; font-size:14px;">Đang chờ admin duyệt để bắt đầu cập nhật tiến độ</div>`;
                    const progress = card.querySelector('.project-progress');
                    if (progress) progress.insertAdjacentHTML('beforebegin', noteHtml); else card.insertAdjacentHTML('beforeend', noteHtml);
                }
            } else if (existing){
                existing.remove();
            }
        }

        // ===== Permissions & Visibility =====
        function canViewProject(p){
            const role = window.__currentRole || 'guest';
            if (role === 'admin' || role === 'manager') return true;
            if (role === 'employee'){
                const me = (window.__currentUserName || '').trim();
                return Array.isArray(p.thanhVien) && p.thanhVien.includes(me);
            }
            // guest: view only (read-only)
            return true;
        }

        function canCreateOrEdit(){
            const role = window.__currentRole || 'guest';
            return role === 'admin' || role === 'manager';
        }

        function applyRolePermissions(){
            const role = window.__currentRole || 'guest';
            // Hide create button for non admin/manager
            const createBtn = document.querySelector('button[onclick="showCreateProjectModal()"]');
            if (createBtn){ createBtn.style.display = canCreateOrEdit() ? '' : 'none'; }
            // Hide settings menu for non admin/manager
            const settings = document.getElementById('settingsWrapper');
            if (settings){ settings.style.display = canCreateOrEdit() ? '' : 'none'; }
            // Filter visible project cards for employees
            document.querySelectorAll('.project-item').forEach(card => {
                const id = card.getAttribute('data-project-id');
                if (!id || !projectDetailsById[id]) return;
                card.style.display = canViewProject(projectDetailsById[id]) ? '' : 'none';
            });
        }

        // ===== Audit log (kho dữ liệu ảo) =====
        function getAuditLog(){
            if (!Array.isArray(window.__audit)) window.__audit = [];
            return window.__audit;
        }
        function saveAuditLog(){
            try { localStorage.setItem('gt_audit', JSON.stringify(getAuditLog())); } catch {}
        }
        function addAuditRecord(projectId, record){
            const entry = Object.assign({ projectId }, record);
            getAuditLog().push(entry);
            saveAuditLog();
        }

        // Quyền xem lịch sử chỉnh sửa
        function canViewAudit(){
            const role = window.__currentRole || 'guest';
            return role === 'admin' || role === 'manager';
        }

        // Mobile menu toggle (if needed)
        function toggleMobileMenu() {
            document.querySelector('.sidebar').classList.toggle('open');
        }

        // User info modal (dynamic based on logged-in account)
        function openUserInfo(){
            let user = null;
            try { user = JSON.parse(localStorage.getItem('gt_user') || 'null'); } catch {}
            const fallbackEmail = 'guest@greentech.com';
            const name = (user && (user.name || user.email)) || 'Guest';
            const email = (user && user.email) || fallbackEmail;
            const role = (user && user.role) || 'guest';
            const roleLabelMap = { admin: 'Quản trị viên', manager: 'Quản lý', employee: 'Nhân viên', guest: '' };
            const roleLabel = roleLabelMap[role] || role;
            const lastLoginIso = (user && user.lastLogin) || localStorage.getItem('gt_last_login') || new Date().toISOString();
            const lastLoginStr = new Date(lastLoginIso).toLocaleString('vi-VN');
            const initial = (name || email || 'G').trim().charAt(0).toUpperCase();

            const html = `
            <div id="userInfoModal" style="position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:3500; display:flex; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:14px; width:95%; max-width:460px; padding:18px; color:#2d3748; box-shadow:0 20px 60px rgba(0,0,0,.2)">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                        <div style="width:44px; height:44px; border-radius:50%; background:#2b7433; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700;">${initial}</div>
                        <div>
                            <div style="font-weight:700;">${name}</div>
                            <div style="font-size:14px; color:#718096;">${email}</div>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr; gap:8px; font-size:14px;">
                        <div><strong>Vai trò:</strong> ${roleLabel}</div>
                        <div><strong>Đăng nhập lần cuối:</strong> ${lastLoginStr}</div>
                    </div>
                    <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
                        <button onclick="document.getElementById('userInfoModal').remove()" style="padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor:pointer;">Đóng</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        // Logout and return to landing page
        function doLogout(){
            try {
                localStorage.removeItem('gt_user');
                localStorage.removeItem('gt_logged_in');
                localStorage.removeItem('gt_last_login');
            } catch (e) {}
            window.location.href = 'trangchu.html';
        }

        // Show yearly report function
        function showYearlyReport() {
            // Build dynamic rows from current projects; keep KPI cards static
            const entries = Object.values(projectDetailsById || {});
            const badgeFor = (status) => {
                if (status === 'Đã hoàn thành') return { bg:'#bee3f8', color:'#2a4365' };
                if (status === 'Chờ phê duyệt') return { bg:'#fed7d7', color:'#742a2a' };
                return { bg:'#c6f6d5', color:'#22543d' };
            };
            const rowsHtml = entries.map((p, idx) => {
                const badge = badgeFor(p.trangThai);
                const usd = (Number(p.mucDauTu) || 0) * 1000; // triệu -> USD nghìn theo mẫu
                return `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px; font-weight: 600;">Dự án ${idx+1}: ${p.ten}</td>
                        <td style="padding: 12px; text-align: center;"><span style="background:${badge.bg}; color:${badge.color}; padding: 6px 10px; border-radius: 9999px; font-size: 12px; font-weight: 600; display: inline-block;">${p.trangThai}</span></td>
                        <td style="padding: 12px; text-align: center;">${Math.max(0, Math.min(100, p.tienDo || 0))}%</td>
                        <td style="padding: 12px; text-align: center;">${usd.toLocaleString('vi-VN')}</td>
                    </tr>`;
            }).join('');
            const totalUsd = entries.reduce((s, p) => s + ((Number(p.mucDauTu) || 0) * 1000), 0).toLocaleString('vi-VN');
            const reportHtml = `
                <div id="reportModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.3s ease;
                ">
                    <div style="
                        background: white;
                        border-radius: 20px;
                        padding: 40px;
                        max-width: 800px;
                        width: 90%;
                        max-height: 80%;
                        overflow-y: auto;
                        position: relative;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    ">
                        <button onclick="closeReport()" style="
                            position: absolute;
                            top: 20px;
                            right: 20px;
                            background: #f56565;
                            color: white;
                            border: none;
                            width: 30px;
                            height: 30px;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 18px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">×</button>
                        
                        <h2 style="color: #2d3748; margin-bottom: 30px; text-align: center; font-size: 28px;">
                            📊 Báo Cáo Năm 2025
                        </h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #f7fafc; padding: 20px; border-radius: 15px; text-align: center;">
                                <h3 style="color: #4a5568; margin-bottom: 10px;">Tổng Dự Án Năm 2025</h3>
                                <p style="font-size: 36px; font-weight: bold; color: #667eea;">24</p>
                                <p style="color: #48bb78;">↗️ Tăng 12% so với 2024</p>
                            </div>
                            
                            <div style="background: #f7fafc; padding: 20px; border-radius: 15px; text-align: center;">
                                <h3 style="color: #4a5568; margin-bottom: 10px;">Dự Án Hoàn Thành</h3>
                                <p style="font-size: 36px; font-weight: bold; color: #48bb78;">18</p>
                                <p style="color: #48bb78;">↗️ Tăng 8% so với 2024</p>
                            </div>
                            
                            <div style="background: #f7fafc; padding: 20px; border-radius: 15px; text-align: center;">
                                <h3 style="color: #4a5568; margin-bottom: 10px;">Đang Thực Hiện</h3>
                                <p style="font-size: 36px; font-weight: bold; color: #f56565;">4</p>
                                <p style="color: #f56565;">↘️ Giảm 2% so với 2024</p>
                            </div>
                            
                            <div style="background: #f7fafc; padding: 20px; border-radius: 15px; text-align: center;">
                                <h3 style="color: #4a5568; margin-bottom: 10px;">Tổng Chi Phí</h3>
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <p style="font-size: 36px; font-weight: bold; color: #667eea;">2.5</p>
                                    <p style="font-size: 16px; font-weight: bold; color: #667eea; margin-top: 5px;">TRIỆU USD</p>
                                </div>
                                <p style="color: #48bb78; margin-top: 10px;">↗️ Tăng 15% so với 2024</p>
                            </div>
                        </div>
                        
                        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 15px; padding: 25px;">
                            <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">Chi Tiết Dự Án Năm 2025</h3>
                            
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 12px; text-align: left; border-radius: 8px 0 0 0;">Tên Dự Án</th>
                                        <th style="padding: 12px; text-align: center;">Trạng Thái</th>
                                        <th style="padding: 12px; text-align: center;">Tiến Độ</th>
                                        <th style="padding: 12px; text-align: center; border-radius: 0 8px 0 0;">Chi Phí (USD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                            
                            <div style="margin-top: 25px; text-align: center; color: #718096;">
                                <p><strong>Tổng cộng:</strong> ${totalUsd} USD</p>
                                <p style="margin-top: 10px; font-style: italic;">Báo cáo được tạo tự động vào ${new Date().toLocaleDateString('vi-VN')}</p>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button onclick="exportReport()" style="
                                background: #48bb78;
                                color: white;
                                border: none;
                                padding: 12px 25px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                margin-right: 10px;
                            ">💾 Xuất PDF</button>
                            
                            <button onclick="closeReport()" style="
                                background: #667eea;
                                color: white;
                                border: none;
                                padding: 12px 25px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">🔙 Đóng</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', reportHtml);
        }

        // Close report function
        function closeReport() {
            const modal = document.getElementById('reportModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Export report function
        function exportReport() {
            showNotification('Đang xuất báo cáo PDF...');
            setTimeout(() => {
                showNotification('Báo cáo đã được tải xuống!');
            }, 2000);
        }

        // Add fade animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.9); }
            }
        `;
        document.head.appendChild(style);
    </script>
    <script>
        // Project details data (extended with status and progress)
        let projectDetailsById = {
            duan1: {
                ten: 'Sân bay Long Thành',
                ma: 'LT-2025-A01',
                quanLy: 'Nguyễn Văn A',
                thanhVien: ['Trần B', 'Lê C', 'Phạm D', 'Vũ E'],
                ngayBatDau: '2025-01-15',
                ngayKetThuc: '2026-12-30',
                mucDauTu: 1200,
                trangThai: 'Đang thực hiện',
                tienDo: 75,
                approved: true,
                image: 'https://cdn2.tuoitre.vn/thumb_w/730/471584752817336320/2025/6/25/hinh-anh-san-bay-long-thanh-phoi-canh-1750815065744231701004.jpg',
                taiLieu: [
                    { ten: 'Báo cáo khả thi', link: '#' },
                    { ten: 'Hợp đồng tổng thầu', link: '#' }
                ]
            },
            duan2: {
                ten: 'Pin Lithium',
                ma: 'PL-2025-B02',
                quanLy: 'Trần Thị B',
                thanhVien: ['Lê C', 'Trần B', 'Đỗ H'],
                ngayBatDau: '2025-03-01',
                ngayKetThuc: '2025-11-30',
                mucDauTu: 800,
                trangThai: 'Chờ phê duyệt',
                tienDo: 10,
                approved: true,
                image: 'https://img-s-msn-com.akamaized.net/tenant/amp/entityid/AA1u3OuV.img?w=768&h=576&m=6',
                taiLieu: [
                    { ten: 'Đề xuất đầu tư', link: '#' },
                    { ten: 'Bản vẽ kỹ thuật', link: '#' }
                ]
            },
            duan3: {
                ten: 'Phần mềm PMIS',
                ma: 'PMIS-2024-C03',
                quanLy: 'Lê Văn C',
                thanhVien: ['Đỗ I', 'Phạm D', 'Đinh L'],
                ngayBatDau: '2024-08-10',
                ngayKetThuc: '2025-02-15',
                mucDauTu: 500,
                trangThai: 'Đã hoàn thành',
                tienDo: 100,
                approved: true,
                image: 'https://pmis.lt/dev/Logo%201.png',
                taiLieu: [
                    { ten: 'Tài liệu yêu cầu', link: '#' },
                    { ten: 'Hướng dẫn triển khai', link: '#' }
                ]
            }
        };

        // Load dữ liệu dự án từ localStorage nếu có
        try {
            const savedData = localStorage.getItem('gt_project_data');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                // Merge với dữ liệu mặc định, ưu tiên dữ liệu đã lưu
                projectDetailsById = { ...projectDetailsById, ...parsedData };
            }
        } catch (e) {
            console.log('Không thể load dữ liệu dự án từ localStorage:', e);
        }

        // Status styles
        const statusStyles = {
            'Đang thực hiện': { bg: '#c6f6d5', color: '#22543d' },
            'Chờ phê duyệt': { bg: '#fed7d7', color: '#742a2a' },
            'Đã hoàn thành': { bg: '#bee3f8', color: '#2a4365' }
        };

        // Decide status from progress (except when pending approval)
        function deriveStatusFromProgress(currentStatus, progress){
            if (currentStatus === 'Chờ phê duyệt') return 'Chờ phê duyệt';
            if ((progress || 0) >= 100) return 'Đã hoàn thành';
            return 'Đang thực hiện';
        }

        // Format date from yyyy-mm-dd to dd/mm/yyyy
        function formatDate(iso) {
            if (!iso || typeof iso !== 'string') return '';
            const parts = iso.split('-');
            if (parts.length !== 3) return iso;
            const [y, m, d] = parts;
            return `${d}/${m}/${y}`;
        }

        // Parse dd/mm/yyyy to ISO yyyy-mm-dd
        function parseDdMmYyyyToIso(ddmmyyyy){
            if (!ddmmyyyy || typeof ddmmyyyy !== 'string') return '';
            const match = ddmmyyyy.trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (!match) return '';
            let [_, d, m, y] = match;
            // Pad to two digits
            if (parseInt(d,10) < 1 || parseInt(d,10) > 31) return '';
            if (parseInt(m,10) < 1 || parseInt(m,10) > 12) return '';
            d = d.padStart(2,'0');
            m = m.padStart(2,'0');
            return `${y}-${m}-${d}`;
        }

        // Open hidden native date input and sync back to text field
        function openNativeDate(nativeId, textId){
            const nativeEl = document.getElementById(nativeId);
            const textEl = document.getElementById(textId);
            if (!nativeEl || !textEl) return;
            // If text has value dd/mm/yyyy, sync to native value first
            const isoFromText = parseDdMmYyyyToIso(textEl.value.trim());
            if (isoFromText) nativeEl.value = isoFromText;
            // Listen once to change and write back formatted dd/mm/yyyy
            const handler = () => {
                const val = nativeEl.value; // yyyy-mm-dd
                if (val){
                    textEl.value = formatDate(val);
                }
                nativeEl.removeEventListener('change', handler);
            };
            nativeEl.addEventListener('change', handler, { once: true });
            // Programmatically open picker
            nativeEl.showPicker ? nativeEl.showPicker() : nativeEl.click();
        }

        // Show Project Details modal
        function showProjectDetails(id) {
            // Kiểm tra và cập nhật trạng thái dựa trên lịch sử trước khi hiển thị
            updateProjectStatusFromAudit();
            
            const data = projectDetailsById[id];
            if (!data) {
                showNotification('Không tìm thấy thông tin dự án');
                return;
            }
            const st = statusStyles[data.trangThai] || { bg: '#e2e8f0', color: '#2d3748' };

            const modalHtml = `
                <div id="projectDetailModal" style="
                    position: fixed;
                    top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.6);
                    display: flex; align-items: center; justify-content: center;
                    z-index: 3000; animation: fadeIn 0.25s ease;
                ">
                    <div style="
                        background: #ffffff; color: #2d3748;
                        width: 95%; max-width: 960px; max-height: 88vh; overflow-y: auto;
                        border-radius: 20px; box-shadow: 0 25px 70px rgba(0,0,0,0.25);
                        position: relative;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #667eea, #48bb78);
                            color: white; padding: 24px 64px 24px 28px; border-radius: 20px 20px 0 0;
                            position: relative; overflow: hidden;
                        ">
                            <div style="position:absolute; inset:0; opacity:.12; background:url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><path d=\"M0 50 L100 50 M50 0 L50 100\" stroke=\"%23ffffff\" stroke-width=\"0.5\" opacity=\"0.6\"/></svg>') repeat;
                            "></div>
                            <div style="position:relative; z-index:1; display:flex; align-items:center; justify-content:space-between; gap:12px;">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <span style="font-weight:700; white-space:nowrap; font-size:25px;">Dự án: ${data.ten}</span>
                                    <img src="${data.image || ''}" alt="thumb" style="width:100px; height:80px; border-radius:10px; object-fit:cover; border:2px solid rgba(255,255,255,.75); box-shadow:0 2px 8px rgba(0,0,0,.25); background: rgba(255,255,255,.2);" onerror="this.style.display='none'" />
                                </div>
                                <span style="background:${st.bg}; color:${st.color}; padding:6px 12px; border-radius:9999px; font-weight:600; font-size: 13px; white-space:nowrap;">${data.trangThai}</span>
                            </div>
                        </div>

                        

                        <div style="padding: 22px 28px 26px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size:20px;">
                                <div><strong>Mã dự án:</strong> ${data.ma}</div>
                                <div><strong>Người quản lý:</strong> ${data.quanLy}</div>
                                <div><strong>Thành viên:</strong> ${data.thanhVien.length}</div>
                                <div><strong>Mức đầu tư:</strong> ${data.mucDauTu.toLocaleString('vi-VN')} triệu USD</div>
                                <div><strong>Ngày bắt đầu:</strong> ${formatDate(data.ngayBatDau)}</div>
                                <div><strong>Ngày kết thúc (dự kiến):</strong> ${formatDate(data.ngayKetThuc)}</div>
                            </div>

                            <div id="detailProgress" style="margin-top: 18px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                    <span style="font-weight:600;">Tiến độ</span>
                                    <span style="font-weight:700; color:#2d3748;">${data.tienDo}%</span>
                                </div>
                                <div style="height: 12px; background:#e2e8f0; border-radius: 9999px; overflow: hidden;">
                                    <div style="
                                        width: ${data.tienDo}%; height:100%; border-radius: 9999px;
                                        background: linear-gradient(90deg, #667eea, #764ba2);
                                        box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
                                    "></div>
                                </div>
                            </div>

                            <div style="margin-top: 22px; display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h3 style="margin-bottom: 8px; font-size:20px;">👥 Danh sách thành viên</h3>
                                    <ul style="margin-left: 18px; line-height:1.7; font-size:18px;">
                                        ${data.thanhVien.map(n => `<li>${n}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <h3 style="margin-bottom: 8px; font-size:20px;">📎 Tài liệu liên quan</h3>
                                    <ul style="margin-left: 18px; line-height:1.7; font-size:18px;">
                                        ${data.taiLieu.map(t => `<li><a style = "text-decoration: none;" href="${t.link}" target="_blank">${t.ten}</a></li>`).join('')}
                                    </ul>
                                </div>
                            </div>

                            <div style="margin-top: 22px; text-align: right;">
                                <button onclick="closeProjectDetails()" style="
                                    background: #667eea; color: #fff; border: none;
                                    padding: 10px 18px; border-radius: 8px; cursor: pointer;
                                ">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const isPending = data.trangThai === 'Chờ phê duyệt';
            if (isPending){
                const modal = document.getElementById('projectDetailModal');
                const prog = modal?.querySelector('#detailProgress');
                if (prog){ prog.style.display = 'none'; }
                const note = document.createElement('div');
                note.style.cssText = 'margin-top:10px; padding:10px 12px; background:#fff7ed; color:#b45309; border:1px solid #fde68a; border-radius:8px;';
                note.textContent = 'Dự án đang chờ phê duyệt. Tiến độ sẽ hiển thị sau khi được duyệt.';
                const insertAfter = modal?.querySelector('#detailProgress');
                if (insertAfter) insertAfter.parentElement.insertBefore(note, insertAfter.nextSibling);
            }
        }

        function closeProjectDetails() {
            const modal = document.getElementById('projectDetailModal');
            if (modal) modal.remove();
        }

        // =============== Create Project Flow ===============
        function showCreateProjectModal() {
            const html = `
                <div id="createProjectModal" style="position: fixed; inset: 0; background: rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:3000; animation: fadeIn .2s ease;">
                    <div style="
                        background: linear-gradient(135deg, #ecfdf5, #d1fae5);
                        border: 1px solid rgba(16,185,129,.25);
                        border-radius:20px; width:85%; max-width:820px; position:relative; color:#064e3b; overflow:hidden;
                        --leaf-top: 500px; --leaf-right: 200px;">
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color:#fff; padding:14px 18px; display:flex; align-items:center; gap:10px;">
                            <span style="font-size:18px;">➕</span>
                            <h3 style="margin:0; font-size:18px;">Tạo dự án mới</h3>
                        </div>
                        <!-- Leafy subtle background pattern -->
                        <div style="position:absolute; inset:0; pointer-events:none; z-index:0; opacity:.07; background-image:url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22160%22 height=%22160%22 viewBox=%220 0 160 160%22%3E%3Cg fill=%22none%22 stroke=%22%2310b981%22 stroke-opacity=%22.6%22 stroke-width=%221%22%3E%3Cpath d=%22M80 12c18 22 18 56 0 78-18-22-18-56 0-78z%22/%3E%3Cpath d=%22M18 80c22 18 56 18 78 0-22-18-56-18-78 0z%22/%3E%3Cpath d=%22M120 40c10 8 10 22 0 30-10-8-10-22 0-30z%22/%3E%3C/g%3E%3C/svg%3E'); background-size:200px 200px; background-repeat:repeat;">&nbsp;</div>
                        <form id="createProjectForm" onsubmit="return submitCreateProject(event)" style="padding:16px 18px 20px; position:relative; z-index:1;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; font-size: 18px;">
                                <div>
                                    <label style="font-weight:600;">Tên dự án</label>
                                    <input required id="cp_ten" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; margin-top: 11px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600;">Mã dự án</label>
                                    <input required id="cp_ma" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; margin-top: 11px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600;">Người quản lý</label>
                                    <input required id="cp_quanly" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; margin-top: 11px;"/>
                                </div>
                                <div>
                                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
                                        <label style="font-weight:600; margin:0;">Thành viên</label>
                                        <button type="button" id="btn_open_members" onclick="openMembersDialog()" style="padding:8px 12px; border:1px solid rgba(16,185,129,.3); background:#fff; color:#059669; border-radius:10px; cursor:pointer;">+ Thêm thành viên</button>
                                </div>
                                    <div id="cp_thanhvien_preview" style="width:100%; padding:12px; border:1px dashed rgba(16,185,129,.4); border-radius:10px; background:#ffffff; color:#6b7280;">
                                        Click "Thêm thành viên" để nhập danh sách
                                    </div>
                                    <input id="cp_thanhvien" placeholder="A, B, C" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; display:none; margin-top: 11px;" readonly/>
                                </div>
                                <div class="date-group">
                                    <label style="font-weight:600;">Ngày bắt đầu</label>
                                    <input required id="cp_start" type="text" placeholder="dd/mm/yyyy" inputmode="numeric" pattern="\\d{1,2}/\\d{1,2}/\\d{4}" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:12px; background:#ffffff; margin-top: 11px;"/>
                                    <input id="cp_start_native" type="date" class="hidden-date" />
                                    <button style="border-radius: 10px; margin-top: 16px;" type="button" class="date-picker-btn" onclick="openNativeDate('cp_start_native','cp_start')">📅</button>
                                </div>
                                <div class="date-group">
                                    <label style="font-weight:600;">Ngày kết thúc (dự kiến)</label>
                                    <input required id="cp_end" type="text" placeholder="dd/mm/yyyy" inputmode="numeric" pattern="\\d{1,2}/\\d{1,2}/\\d{4}" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; margin-top: 11px;"/>
                                    <input id="cp_end_native" type="date" class="hidden-date" />
                                    <button style="border-radius: 10px; margin-top: 16px;" type="button" class="date-picker-btn" onclick="openNativeDate('cp_end_native','cp_end')">📅</button>
                                </div>
                                <div>
                                    <label style="font-weight:600;">Mức đầu tư (triệu USD)</label>
                                    <input required id="cp_dautu" type="number" min="0" step="0.01" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; margin-top: 11px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600;">Trạng thái</label>
                                    <select id="cp_trangthai" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; margin-top: 11px;">
                                        <option>Đang thực hiện</option>
                                        <option>Chờ phê duyệt</option>
                                        <option>Đã hoàn thành</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight:600;">Tiến độ (%)</label>
                                    <input id="cp_tiendo" type="number" min="0" max="100" value="0" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; margin-top: 11px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600;">Ảnh đại diện (URL)</label>
                                    <input id="cp_image_url" placeholder="https://...jpg" style="width:100%; padding:12px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; margin-top: 11px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600;">Hoặc tải ảnh</label>
                                    <input id="cp_image_file" type="file" accept="image/*" style="width:100%; padding:10px; border:1px solid rgba(16,185,129,.3); border-radius:10px; background:#ffffff; margin-top: 11px;" onchange="previewUpload(event)"/>
                                    <img id="cp_preview" style="margin-top:8px; max-height:140px; border-radius:10px; display:none; box-shadow:0 6px 16px rgba(0,0,0,.08);"/>
                                </div>
                            </div>
                            <div aria-hidden="true" id="leafNearUrl" style="position:absolute; right:var(--leaf-right); top:var(--leaf-top); font-size:95px; opacity:0.2; pointer-events:none;">🌿</div>
                            <div id="formActions" style="margin-top:14px; display:flex; justify-content:flex-end; align-items:center; gap:10px;">
                                <div id="formActionButtons" style="display:flex; gap:10px;">
                                    <button type="button" onclick="closeCreateProjectModal()" style="padding:8px 14px; border-radius:10px; border:1px solid rgba(16,185,129,.3); background:#fff; color:#059669; cursor: pointer; font-size: 14px;">Hủy</button>
                                    <button type="submit" style="padding:8px 14px; border-radius:10px; border:none; background: linear-gradient(135deg, #10b981, #059669); color:#fff; box-shadow:0 8px 20px rgba(16,185,129,.25); cursor: pointer; font-size: 14px;">Lưu dự án</button>
                                </div>
                            </div>
                        
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            attachMembersPreviewBehavior();
            // For create mode, force status to "Chờ phê duyệt" and lock select
            const statusEl = document.getElementById('cp_trangthai');
            if (statusEl){
                statusEl.value = 'Chờ phê duyệt';
                statusEl.disabled = true;
                statusEl.title = 'Trạng thái sẽ là Chờ phê duyệt khi tạo mới';
            }
        }

        function closeCreateProjectModal(){
            const m = document.getElementById('createProjectModal');
            if (m) m.remove();
        }

        function attachMembersPreviewBehavior(){
            const hidden = document.getElementById('cp_thanhvien');
            const preview = document.getElementById('cp_thanhvien_preview');
            if (!hidden || !preview) return;
            if (hidden.value){
                preview.textContent = hidden.value.split(',').map(s=>s.trim()).filter(Boolean).join(', ');
            }
        }

        function openMembersDialog(){
            const existing = (document.getElementById('cp_thanhvien').value || '').split(',').map(s=>s.trim()).filter(Boolean);
            const modal = `
            <div id="membersModal" style="position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:4000; display:flex; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:14px; width:95%; max-width:560px; padding:18px; color:#2d3748;">
                    <h3 style="margin:0 0 8px 0;">Thêm thành viên</h3>
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
                        <label>Số lượng:</label>
                        <input id="membersCount" type="number" min="1" max="50" value="${Math.max(1, existing.length || 1)}" style="width:100px; padding:8px; border:1px solid #e2e8f0; border-radius:8px;"/>
                        <button onclick="renderMemberInputs()" style="padding:8px 12px; border:none; background:#667eea; color:#fff; border-radius:8px; cursor:pointer;">Tạo ô nhập</button>
                    </div>
                    <div id="membersInputs" style="display:grid; grid-template-columns:1fr; gap:8px; max-height:50vh; overflow:auto;"></div>
                    <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
                        <button onclick="document.getElementById('membersModal').remove()" style="padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor:pointer;">Hủy</button>
                        <button onclick="saveMembersFromDialog()" style="padding:8px 12px; border:none; background:#10b981; color:#fff; border-radius:8px; cursor:pointer;">Lưu</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
            // initial render
            renderMemberInputs(existing);
        }

        function renderMemberInputs(prefill){
            const container = document.getElementById('membersInputs');
            if (!container) return;
            const countInput = document.getElementById('membersCount');
            const n = Math.max(1, parseInt(countInput?.value || '1', 10));
            const existing = Array.isArray(prefill) ? prefill : (document.getElementById('cp_thanhvien').value || '').split(',').map(s=>s.trim()).filter(Boolean);
            let html = '';
            for (let i=0; i<n; i++){
                const val = existing[i] || '';
                html += `<input class="member-name" placeholder="Tên thành viên ${i+1}" value="${val}" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px;"/>`;
            }
            container.innerHTML = html;
        }

        function openAttachmentDialog(projectId){
            const html = `
            <div id=\"attachModal\" style=\"position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:4000; display:flex; align-items:center; justify-content:center;\">\n                <div style=\"background:#fff; border-radius:14px; width:95%; max-width:560px; padding:18px; color:#2d3748;\">\n                    <h3 style=\"margin:0 0 8px 0;\">Thêm tài liệu đính kèm</h3>\n                    <div style=\"font-size:13px; color:#718096; margin-bottom:8px;\">Chọn số lượng để tạo ra bấy nhiêu ô tải file.</div>\n                    <div style=\"display:flex; align-items:center; gap:8px; margin-bottom:10px;\">\n                        <label for=\"att_count\">Số lượng:</label>\n                        <input id=\"att_count\" type=\"number\" min=\"1\" max=\"20\" value=\"1\" style=\"width:90px; padding:8px; border:1px solid #e2e8f0; border-radius:8px;\"/>\n                        <button onclick=\"renderAttachmentInputs()\" style=\"padding:8px 12px; border:none; background:#667eea; color:#fff; border-radius:8px; cursor:pointer;\">Tạo ô nhập</button>\n                    </div>\n                    <div id=\"att_inputs\" style=\"display:grid; grid-template-columns:1fr; gap:8px; max-height:50vh; overflow:auto;\"></div>\n                    <div style=\"margin-top:12px; display:flex; justify-content:flex-end; gap:8px;\">\n                        <button onclick=\"document.getElementById('attachModal').remove()\" style=\"padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor:pointer;\">Hủy</button>\n                        <button onclick=\"saveAttachment('${projectId}')\" style=\"padding:8px 12px; border:none; background:#10b981; color:#fff; border-radius:8px; cursor:pointer;\">Lưu</button>\n                    </div>\n                </div>\n            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            renderAttachmentInputs();
        }

        function renderAttachmentInputs(){
            const container = document.getElementById('att_inputs');
            const n = Math.max(1, parseInt(document.getElementById('att_count').value || '1', 10));
            let html = '';
            for (let i=0; i<n; i++){
                html += `<input class=\"attach-file\" type=\"file\" style=\"width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:8px;\"/>`;
            }
            container.innerHTML = html;
        }

        function saveAttachment(projectId){
            const inputs = Array.from(document.querySelectorAll('#att_inputs .attach-file'));
            const files = inputs.map(i => i.files && i.files[0]).filter(Boolean);
            if (!files.length){ showNotification('Vui lòng chọn ít nhất 1 file'); return; }
            const p = projectDetailsById[projectId];
            if (!p){ showNotification('Không tìm thấy dự án'); return; }
            p.taiLieu = p.taiLieu || [];
            files.forEach(file => {
                const url = URL.createObjectURL(file);
                p.taiLieu.push({ ten: file.name, link: url });
            });
            document.getElementById('attachModal').remove();
            showNotification('Đã thêm tài liệu đính kèm');
        }

        function saveMembersFromDialog(){
            const modal = document.getElementById('membersModal');
            const inputs = modal ? modal.querySelectorAll('.member-name') : [];
            const names = Array.from(inputs).map(i=>i.value.trim()).filter(Boolean);
            const hidden = document.getElementById('cp_thanhvien');
            const preview = document.getElementById('cp_thanhvien_preview');
            hidden.value = names.join(', ');
            if (preview){ preview.textContent = names.length ? names.join(', ') : 'Nhấn nút "Thêm thành viên" để nhập danh sách'; }
            if (modal) modal.remove();
        }

        function previewUpload(e){
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const img = document.getElementById('cp_preview');
            const reader = new FileReader();
            reader.onload = () => { img.src = reader.result; img.style.display = 'block'; };
            reader.readAsDataURL(file);
        }

        function submitCreateProject(ev){
            ev.preventDefault();
            const ten = document.getElementById('cp_ten').value.trim();
            const ma = document.getElementById('cp_ma').value.trim();
            const quanLy = document.getElementById('cp_quanly').value.trim();
            const thanhVien = (document.getElementById('cp_thanhvien').value || '').split(',').map(s=>s.trim()).filter(Boolean);
            const ngayBatDauInput = document.getElementById('cp_start').value.trim();
            const ngayKetThucInput = document.getElementById('cp_end').value.trim();
            const ngayBatDau = parseDdMmYyyyToIso(ngayBatDauInput);
            const ngayKetThuc = parseDdMmYyyyToIso(ngayKetThucInput);
            if (!ngayBatDau || !ngayKetThuc){
                showNotification('Ngày không hợp lệ. Vui lòng nhập theo định dạng dd/mm/yyyy');
                return false;
            }
            if (!thanhVien.length){
                showNotification('Vui lòng thêm ít nhất 1 thành viên');
                return false;
            }
            const mucDauTu = parseFloat(document.getElementById('cp_dautu').value || '0');
            // Default new projects to "Chờ phê duyệt" regardless of dropdown
            const trangThai = 'Chờ phê duyệt';
            const tienDo = parseInt(document.getElementById('cp_tiendo').value || '0', 10);
            const imageUrl = document.getElementById('cp_image_url').value.trim();
            const preview = document.getElementById('cp_preview');
            const image = imageUrl || (preview && preview.src) || '';

            const id = 'duan_' + Date.now();
            // Editing existing project if data-edit-id present
            const formEl = document.getElementById('createProjectForm');
            const editId = formEl?.getAttribute('data-edit-id');
            let targetId = editId || id;
            let finalTrangThai = trangThai;
            let finalTienDo = tienDo;
            let approved = false;
            if (!editId){
                // New project: force pending approval
                finalTrangThai = 'Chờ phê duyệt';
                finalTienDo = 0;
            } else {
                // Preserve approval flag if existed
                approved = !!projectDetailsById[editId]?.approved;
                // Use current selection/status when editing (do NOT force pending)
                finalTrangThai = document.getElementById('cp_trangthai').value || projectDetailsById[editId]?.trangThai || 'Đang thực hiện';
            }
            // NEW: normalize progress and derive status automatically (except when pending)
            const normalizedProgress = Math.max(0, Math.min(100, finalTienDo));
            const statusNow = deriveStatusFromProgress(finalTrangThai, normalizedProgress);
            // Build audit entry
            const existing = projectDetailsById[targetId] || {};
            const audit = existing.audit || [];
            const actor = (window.__currentUserName || 'User');
            const role = (window.__currentRole || 'guest');
            const timestamp = new Date().toISOString();
            const changes = [];
            if (existing.ten && existing.ten !== ten) changes.push('Tên dự án');
            if (existing.ma && existing.ma !== ma) changes.push('Mã dự án');
            if (existing.quanLy && existing.quanLy !== quanLy) changes.push('Người quản lý');
            if (JSON.stringify(existing.thanhVien||[]) !== JSON.stringify(thanhVien)) changes.push('Thành viên');
            if (existing.ngayBatDau && existing.ngayBatDau !== ngayBatDau) changes.push('Ngày bắt đầu');
            if (existing.ngayKetThuc && existing.ngayKetThuc !== ngayKetThuc) changes.push('Ngày kết thúc');
            if (typeof existing.mucDauTu === 'number' && existing.mucDauTu !== mucDauTu) changes.push('Mức đầu tư');
            if (existing.trangThai && existing.trangThai !== statusNow) changes.push('Trạng thái');
            if (typeof existing.tienDo === 'number' && existing.tienDo !== normalizedProgress) changes.push('Tiến độ');
            const action = existing.ten ? (changes.length ? ('Sửa: ' + changes.join(', ')) : 'Cập nhật không thay đổi') : 'Tạo dự án';
            const record = { actor, role, action, at: timestamp };
            audit.push(record);
            if (typeof addAuditRecord === 'function') addAuditRecord(targetId, record);
            projectDetailsById[targetId] = { ten, ma, quanLy, thanhVien, ngayBatDau, ngayKetThuc, mucDauTu, trangThai: statusNow, tienDo: normalizedProgress, image, taiLieu: projectDetailsById[targetId]?.taiLieu || [], approved, audit };
            window.__lastCreatedProjectId = targetId;
            
            // Lưu dữ liệu dự án vào localStorage để đồng bộ
            try {
                localStorage.setItem('gt_project_data', JSON.stringify(projectDetailsById));
            } catch (e) {
                console.log('Không thể lưu dữ liệu dự án:', e);
            }

            const list = document.querySelector('.project-list');
            if (list){
                const statusClass = (statusNow === 'Đã hoàn thành') ? 'status-completed' : (statusNow === 'Chờ phê duyệt' ? 'status-pending' : 'status-active');
                // Update existing card if editing; otherwise add new card
                let card = list.querySelector(`.project-item[data-project-id="${targetId}"]`);
                const progressHtml = `
                    <div class="project-progress" style="${statusNow==='Chờ phê duyệt' ? 'display:none;' : ''}"> 
                        <div class="progress-bar"> 
                            <div class="progress-fill" style="width: ${normalizedProgress}%; height: 100%;"></div> 
                        </div> 
                        <div class="progress-text">Hoàn thành ${normalizedProgress}%</div> 
                    </div>`;
                if (card){
                    const nameEl = card.querySelector('.project-name');
                    // Preserve 'Dự án N:' prefix if present
                    let prefix = '';
                    const firstNode = nameEl.childNodes[0];
                    const rawTitle = firstNode && firstNode.nodeType === Node.TEXT_NODE ? firstNode.textContent.trim() : '';
                    const matched = rawTitle && rawTitle.match(/^Dự án\s*\d+:/i);
                    if (matched && matched[0]) {
                        prefix = matched[0] + ' ';
                    }
                    nameEl.innerHTML = `${prefix}${ten}<div class="project-status ${statusClass}">${statusNow}</div>`;
                    const imgEl = card.querySelector('.project-image');
                    if (imgEl){
                        if (image) { imgEl.src = image; imgEl.alt = ten; }
                        else { imgEl.remove(); }
                    } else if (image) {
                        card.querySelector('.project-header').insertAdjacentHTML('beforeend', `<img src="${image}" alt="${ten}" class="project-image">`);
                    }
                    const prog = card.querySelector('.project-progress');
                    if (prog) prog.outerHTML = progressHtml; else card.insertAdjacentHTML('beforeend', progressHtml);
                    addOrRemovePendingNote(card, statusNow === 'Chờ phê duyệt');
                } else {
                    const orderNumber = list.querySelectorAll('.project-item').length + 1;
                    const displayName = `Dự án ${orderNumber}: ${ten}`;
                const itemHtml = `
                    <div class="project-item" data-project-id="${targetId}">
                    <div class="project-header">
                        <div class="project-name">
                                ${displayName}
                                <div class="project-status ${statusClass}">${statusNow}</div>
                        </div>
                        ${image ? `<img src="${image}" alt="${ten}" class="project-image">` : ''}
                    </div>
                        ${progressHtml}
                    <div style="margin-top: 12px; text-align: right;">
                            <button class="btn-detail" onclick="showProjectDetails('${targetId}')">🔎 Xem chi tiết</button>
                    </div>
                </div>`;
                list.insertAdjacentHTML('afterbegin', itemHtml);
                }
            }

            closeCreateProjectModal();
            showNotification('Đã tạo/cập nhật dự án');
            return false;
        }

        function openEditLatestProject(){
            const id = window.__lastCreatedProjectId;
            if (!id || !projectDetailsById[id]) { showNotification('Chưa có dự án để chỉnh sửa'); return; }
            const p = projectDetailsById[id];
            if (p.trangThai === 'Chờ phê duyệt' && window.__currentRole !== 'admin') { showNotification('Dự án đang chờ phê duyệt. Vui lòng duyệt trước khi chỉnh sửa'); return; }
            showCreateProjectModal();
            document.getElementById('cp_ten').value = p.ten;
            document.getElementById('cp_ma').value = p.ma;
            document.getElementById('cp_quanly').value = p.quanLy;
            document.getElementById('cp_thanhvien').value = p.thanhVien.join(', ');
            attachMembersPreviewBehavior();
            document.getElementById('cp_start').value = formatDate(p.ngayBatDau);
            document.getElementById('cp_end').value = formatDate(p.ngayKetThuc);
            const startNative = document.getElementById('cp_start_native');
            const endNative = document.getElementById('cp_end_native');
            if (startNative) startNative.value = p.ngayBatDau;
            if (endNative) endNative.value = p.ngayKetThuc;
            document.getElementById('cp_dautu').value = p.mucDauTu;
            document.getElementById('cp_trangthai').value = p.trangThai;
            document.getElementById('cp_tiendo').value = p.tienDo;
            document.getElementById('cp_image_url').value = p.image || '';
            const prev = document.getElementById('cp_preview');
            if (p.image){ prev.src = p.image; prev.style.display = 'block'; }
            // attachment button in edit mode
            const form = document.getElementById('createProjectForm');
            const attachBtnId = 'btn_add_attachments';
            if (!document.getElementById(attachBtnId)){
                const actions = document.getElementById('formActionButtons');
                const btn = document.createElement('button');
                btn.id = attachBtnId;
                btn.type = 'button';
                btn.textContent = '+ Thêm tài liệu đính kèm';
                btn.style.cssText = 'padding:8px 12px; border:none; background: linear-gradient(135deg, #10b981, #059669); border-radius:8px; cursor:pointer; color:#ffffff; margin-right:auto;';
                const container = document.getElementById('formActions');
                // Insert on the left side of Cancel/Save
                if (container){ container.insertBefore(btn, actions); }
                btn.addEventListener('click', () => openAttachmentDialog(id));
            }
        }

        function deleteLatestProject(){
            let id = window.__selectedProjectId;
            if (!id){
                const hovered = document.querySelector('.project-item:hover');
                if (hovered && hovered.getAttribute('data-project-id')) id = hovered.getAttribute('data-project-id');
            }
            if (!id) id = window.__lastCreatedProjectId;
            if (!id || !projectDetailsById[id]) { showNotification('Không có dự án để xóa'); return; }
            // lưu vào thùng rác
            window.__trash = window.__trash || [];
            window.__trash.push({ id, data: projectDetailsById[id], deletedAt: new Date() });
            updateTrashBadge();
            delete projectDetailsById[id];
            // Xóa card khớp id, nếu có
            const list = document.querySelector('.project-list');
            if (list){
                const card = list.querySelector(`.project-item[data-project-id="${id}"]`) || list.firstElementChild;
                if (card) card.remove();
            }
            showNotification('Đã xóa dự án thành công');
            window.__lastCreatedProjectId = null;
        }

        function updateTrashBadge(){
            const el = document.getElementById('trashCount');
            if (el) el.textContent = (window.__trash?.length || 0);
        }

        function openTrash(){
            const items = window.__trash || [];
            const content = items.length ? items.map(t => `
                <div class="project-item" style="margin-bottom:12px;">
                    <div class="project-header">
                        <div class="project-name">${t.data.ten}<div class="project-status status-pending">Đã xóa</div></div>
                    </div>
                    <div style="font-size:14px; color:#718096; margin-bottom:8px;">Xóa lúc: ${t.deletedAt.toLocaleString('vi-VN')}</div>
                    <div style="display:flex; gap:8px;">
                        <button onclick="restoreProject('${t.id}')" style="padding:8px 12px; border:1px solid #48bb78; color:#48bb78; background:#fff; border-radius:8px; cursor:pointer;">Khôi phục</button>
                        <button onclick="purgeProject('${t.id}')" style="padding:8px 12px; border:1px solid #f56565; color:#f56565; background:#fff; border-radius:8px; cursor:pointer;">Xóa vĩnh viễn</button>
                    </div>
                </div>
            `).join('') : '<div style="color:#718096;">Chưa có dự án bị xóa</div>';

            const modal = `
            <div id="trashModal" style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:3000; display:flex; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:16px; width:96%; max-width:900px; max-height:88vh; overflow:auto; padding:24px; color:#2d3748;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h3 style="margin:0;">Thùng rác</h3>
                        <button onclick="document.getElementById('trashModal').remove()" style="padding:8px 12px; border:none; border-radius:8px; background:#667eea; color:#fff; cursor:pointer;">Đóng</button>
                    </div>
                    <div class="project-list" style="gap:16px;">
                        ${content}
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        function restoreProject(id){
            const idx = (window.__trash || []).findIndex(t => t.id === id);
            if (idx === -1) return;
            const rec = window.__trash.splice(idx,1)[0];
            projectDetailsById[id] = rec.data;
            updateTrashBadge();
            // thêm lại vào danh sách
            const list = document.querySelector('.project-list');
            if (list){
                const p = rec.data;
                const statusClass = p.trangThai === 'Đã hoàn thành' ? 'status-completed' : (p.trangThai === 'Chờ phê duyệt' ? 'status-pending' : 'status-active');
                const orderNumber = list.querySelectorAll('.project-item').length + 1;
                const displayName = `Dự án ${orderNumber}: ${p.ten}`;
                const html = `
                <div class="project-item" data-project-id="${id}">
                    <div class="project-header">
                        <div class="project-name">${displayName}<div class="project-status ${statusClass}">${p.trangThai}</div></div>
                        ${p.image ? `<img src="${p.image}" alt="${p.ten}" class="project-image">` : ''}
                    </div>
                    <div class="project-progress">
                        <div class="progress-bar"><div class="progress-fill" style="width:${Math.max(0, Math.min(100, p.tienDo))}%; height:100%;"></div></div>
                        <div class="progress-text">Hoàn thành ${Math.max(0, Math.min(100, p.tienDo))}%</div>
                    </div>
                    <div style="margin-top:12px; text-align:right;">
                        <button class="btn-detail" onclick="showProjectDetails('${id}')">🔎 Xem chi tiết</button>
                    </div>
                </div>`;
                list.insertAdjacentHTML('afterbegin', html);
            }
            showNotification('Đã khôi phục dự án');
            const modal = document.getElementById('trashModal'); if (modal) modal.remove();
        }

        function purgeProject(id){
            const idx = (window.__trash || []).findIndex(t => t.id === id);
            if (idx === -1) return;
            window.__trash.splice(idx,1);
            updateTrashBadge();
            showNotification('Đã xóa vĩnh viễn');
            const modal = document.getElementById('trashModal'); if (modal) modal.remove();
        }

        // Hàm tự động cập nhật trạng thái dự án dựa trên lịch sử duyệt và tiến độ
        function updateProjectStatusFromAudit() {
            const audit = getAuditLog();
            
            // Tìm các dự án đã được duyệt trong lịch sử
            const approvedProjects = new Set();
            
            audit.forEach(record => {
                if (record.action === 'Duyệt dự án' && record.projectId) {
                    approvedProjects.add(record.projectId);
                }
            });

            // Cập nhật trạng thái dự án trong dữ liệu
            approvedProjects.forEach(projectId => {
                if (projectDetailsById[projectId] && projectDetailsById[projectId].trangThai === 'Chờ phê duyệt') {
                    projectDetailsById[projectId].trangThai = 'Đang thực hiện';
                    projectDetailsById[projectId].approved = true;
                    
                    // Tìm thời điểm duyệt gần nhất
                    const approvalRecord = audit.find(r => 
                        r.projectId === projectId && 
                        r.action === 'Duyệt dự án'
                    );
                    
                    if (approvalRecord) {
                        // Tìm cập nhật tiến độ sau khi duyệt
                        const progressUpdate = audit.find(r => 
                            r.projectId === projectId && 
                            r.action && r.action.includes('Tiến độ') && 
                            new Date(r.at) > new Date(approvalRecord.at)
                        );
                        
                        if (progressUpdate) {
                            // Có cập nhật tiến độ sau khi duyệt, giữ nguyên tiến độ hiện tại
                            // (giá trị đã được cập nhật trong projectDetailsById)
                        } else {
                            // Không có cập nhật tiến độ sau khi duyệt, reset về 0%
                            projectDetailsById[projectId].tienDo = 0;
                        }
                    }
                }
            });

            // Cập nhật giao diện cho các card dự án
            approvedProjects.forEach(projectId => {
                const card = document.querySelector(`.project-item[data-project-id="${projectId}"]`);
                if (card) {
                    const statusEl = card.querySelector('.project-status');
                    const progress = card.querySelector('.project-progress');
                    const progressFill = card.querySelector('.progress-fill');
                    const progressText = card.querySelector('.progress-text');
                    
                    if (statusEl) {
                        statusEl.textContent = 'Đang thực hiện';
                        statusEl.className = 'project-status status-active';
                    }
                    
                    if (progress) {
                        progress.style.display = '';
                        const pendingNote = card.querySelector('.pending-note');
                        if (pendingNote) pendingNote.remove();
                    }
                    
                    // Cập nhật tiến độ hiển thị
                    if (progressFill && progressText) {
                        const currentProgress = projectDetailsById[projectId]?.tienDo || 0;
                        progressFill.style.width = `${currentProgress}%`;
                        progressText.textContent = `Hoàn thành ${currentProgress}%`;
                    }
                }
            });
        }

        function openDeleteChooser(){
            // Modal chọn dự án cần xóa từ danh sách hiện có
            const ids = Object.keys(projectDetailsById);
            const options = ids.map(id => `<option value="${id}">${projectDetailsById[id].ten}</option>`).join('');
            const html = `
            <div id="deleteChooser" style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:3000; display:flex; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:12px; padding:20px; width:95%; max-width:480px;">
                    <h3 style="margin-top:0;">Chọn dự án để xóa</h3>
                    <select id="del_select" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin:10px 0; cursor: pointer; font-size: 15px;">
                        ${options}
                    </select>
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                        <button onclick="openTrash()" style="padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor: pointer; font-size: 15px;">🗑️ Thùng rác (<span id='trashCountInline'>${(window.__trash?.length)||0}</span>)</button>
                        <button onclick="document.getElementById('deleteChooser').remove()" style="padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor: pointer; font-size: 15px;">Hủy</button>
                        <button onclick="confirmDeleteChosen()" style="padding:8px 12px; border:none; background:#f56565; color:#fff; border-radius:8px; cursor: pointer; font-size: 15px;">Xóa</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function openEditChooser(){
            const ids = Object.keys(projectDetailsById);
            const options = ids.map(id => `<option value="${id}">${projectDetailsById[id].ten}</option>`).join('');
            const html = `
            <div id="editChooser" style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:3000; display:flex; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:12px; padding:20px; width:95%; max-width:480px;">
                    <h3 style="margin-top:0;">Chọn dự án để chỉnh sửa</h3>
                    <select id="edit_select" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin:10px 0; cursor: pointer; font-size: 15px;">
                        ${options}
                    </select>
                    <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                        <button id="btn_view_history" onclick="viewProjectHistory()" style="padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor: pointer; font-size: 15px;">📜 Lịch sử</button>
                        <button onclick="document.getElementById('editChooser').remove()" style="padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor: pointer; font-size: 15px;">Hủy</button>
                        <button onclick="confirmEditChosen()" style="padding:8px 12px; border:none; background:#667eea; color:#fff; border-radius:8px; cursor: pointer; font-size: 15px;">Chỉnh sửa</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function viewProjectHistory(){
            const sel = document.getElementById('edit_select');
            if (!sel) return;
            const id = sel.value;
            const p = projectDetailsById[id];
            if (!p){ showNotification('Không tìm thấy dự án'); return; }
            // Permission: admin/manager OK; employee only if member
            const role = window.__currentRole || 'guest';
            if (role === 'employee'){
                const me = (window.__currentUserName || '').trim();
                const isMember = Array.isArray(p.thanhVien) && p.thanhVien.includes(me);
                if (!isMember){ showNotification('Bạn không có quyền xem lịch sử dự án này'); return; }
            } else if (!canViewAudit()){
                showNotification('Bạn không có quyền xem lịch sử'); return;
            }
            const items = (p.audit || []).slice().reverse();
            const roleLabelMap = { admin: 'Quản trị viên', manager: 'Quản lý', employee: 'Nhân viên', guest: '' };
            const rows = items.length ? items.map(a => {
                const rlabel = roleLabelMap[a.role] || a.role;
                return `
                <tr>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${new Date(a.at).toLocaleString('vi-VN')}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${a.actor}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${rlabel}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${a.action}</td>
                </tr>`;
            }).join('') : '<tr><td colspan="4" style="padding:12px; text-align:center; color:#718096;">Chưa có lịch sử</td></tr>';
            const modal = `
            <div id="historyModal" style="position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:3400; display:flex; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:14px; width:95%; max-width:720px; padding:18px; color:#2d3748;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0;">Lịch sử cập nhật: ${p.ten}</h3>
                        <button onclick="document.getElementById('historyModal').remove()" style="padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor:pointer;">Đóng</button>
                    </div>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f7fafc;">
                                <th style="text-align:left; padding:8px;">Thời gian</th>
                                <th style="text-align:left; padding:8px;">Người thực hiện</th>
                                <th style="text-align:left; padding:8px;">Vai trò</th>
                                <th style="text-align:left; padding:8px;">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
        // Lịch sử cho Nhân viên từ danh sách "Dự án của tôi"
        function viewProjectHistoryFor(id){
            const p = projectDetailsById[id];
            if (!p){ showNotification('Không tìm thấy dự án'); return; }
            const role = window.__currentRole || 'guest';
            if (role !== 'employee'){ showNotification('Chức năng này dành cho Nhân viên'); return; }
            const me = (window.__currentUserName || '').trim();
            const isMember = Array.isArray(p.thanhVien) && p.thanhVien.includes(me);
            if (!isMember){ showNotification('Bạn không có quyền xem lịch sử dự án này'); return; }
            // Lấy lịch sử từ kho ảo để nhân viên có thể xem lại sau này
            const all = (typeof getAuditLog === 'function' ? getAuditLog() : []);
            const items = all.filter(a => a.projectId === id && (a.role === 'admin' || a.role === 'manager')).slice().reverse();
            const roleLabelMap = { admin: 'Quản trị viên', manager: 'Quản lý' };
            const rows = items.length ? items.map(a => `
                <tr>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${new Date(a.at).toLocaleString('vi-VN')}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${a.actor}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${roleLabelMap[a.role] || a.role}</td>
                    <td style="padding:8px; border-bottom:1px solid #e2e8f0;">${a.action}</td>
                </tr>`).join('') : '<tr><td colspan="4" style="padding:12px; text-align:center; color:#718096;">Chưa có lịch sử từ quản lý/admin</td></tr>';
            const modal = `
            <div id="historyModal" style="position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:3400; display:flex; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:14px; width:95%; max-width:720px; padding:18px; color:#2d3748;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0;">Lịch sử cập nhật (QL/Admin): ${p.ten}</h3>
                        <button onclick="document.getElementById('historyModal').remove()" style="padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor:pointer;">Đóng</button>
                    </div>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f7fafc;">
                                <th style="text-align:left; padding:8px;">Thời gian</th>
                                <th style="text-align:left; padding:8px;">Người thực hiện</th>
                                <th style="text-align:left; padding:8px;">Vai trò</th>
                                <th style="text-align:left; padding:8px;">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
        function openApproveChooser(){
            const ids = Object.keys(projectDetailsById).filter(id => projectDetailsById[id]?.trangThai === 'Chờ phê duyệt');
            if (!ids.length){
                showNotification('Không có dự án chờ phê duyệt');
                return;
            }
            const options = ids.map(id => `<option value="${id}">${projectDetailsById[id].ten}</option>`).join('');
            const html = `
            <div id="approveChooser" style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:3000; display:flex; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:12px; padding:20px; width:95%; max-width:520px;">
                    <h3 style="margin-top:0;">Duyệt dự án</h3>
                    <select id="approve_select" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin:10px 0; cursor: pointer; font-size: 15px;">
                        ${options}
                    </select>
                    <div style="display:flex; justify-content:flex-end; gap:10px;">
                        <button onclick="document.getElementById('approveChooser').remove()" style="padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:8px; cursor: pointer; font-size: 15px;">Hủy</button>
                        <button onclick="confirmApproveChosen()" style="padding:8px 12px; border:none; background:#10b981; color:#fff; border-radius:8px; cursor: pointer; font-size: 15px;">Duyệt</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        function confirmApproveChosen(){
            const sel = document.getElementById('approve_select');
            if (!sel) return;
            const id = sel.value;
            const p = projectDetailsById[id];
            if (!p){ showNotification('Không tìm thấy dự án'); return; }
            if (p.trangThai !== 'Chờ phê duyệt') { showNotification('Dự án đã được duyệt trước đó'); document.getElementById('approveChooser').remove(); return; }
            p.trangThai = 'Đang thực hiện';
            p.approved = true;
            // Sau khi duyệt, tiến độ phải bắt đầu từ 0%
            p.tienDo = 0;
            // cập nhật card hiển thị nếu đang có
            const card = document.querySelector(`.project-item[data-project-id="${id}"]`);
            if (card){
                const statusEl = card.querySelector('.project-status');
                if (statusEl){ statusEl.textContent = p.trangThai; statusEl.className = 'project-status status-active'; }
                const fill = card.querySelector('.progress-fill');
                const text = card.querySelector('.progress-text');
                if (fill) fill.style.width = `0%`;
                if (text) text.textContent = `Hoàn thành 0%`;
                const prog = card.querySelector('.project-progress');
                if (prog) prog.style.display = '';
                addOrRemovePendingNote(card, false);
                const pendingNote = card.querySelector('.pending-note'); if (pendingNote) pendingNote.remove();
            }
            // lưu audit ảo
            if (typeof addAuditRecord === 'function'){
                const actor = (window.__currentUserName || 'User');
                const role = (window.__currentRole || 'guest');
                addAuditRecord(id, { actor, role, action: 'Duyệt dự án', at: new Date().toISOString() });
            }
            document.getElementById('approveChooser').remove();
            showNotification('Đã duyệt dự án, có thể cập nhật tiến độ');
            
            // Tự động mở dự án sau khi duyệt để thành viên có thể thấy tiến trình
            setTimeout(() => {
                showProjectDetails(id);
            }, 1000); // Đợi 1 giây để notification hiển thị trước
        }
        function confirmEditChosen(){
            const sel = document.getElementById('edit_select');
            if (!sel) return;
            const id = sel.value;
            document.getElementById('editChooser').remove();
            // mở form edit theo id đã chọn
            const p = projectDetailsById[id];
            if (p && p.trangThai === 'Chờ phê duyệt') { showNotification('Dự án đang chờ phê duyệt. Vui lòng duyệt trước khi chỉnh sửa'); return; }
            showCreateProjectModal();
            document.getElementById('cp_ten').value = p.ten;
            document.getElementById('cp_ma').value = p.ma;
            document.getElementById('cp_quanly').value = p.quanLy;
            document.getElementById('cp_thanhvien').value = p.thanhVien.join(', ');
            attachMembersPreviewBehavior();
            document.getElementById('cp_start').value = formatDate(p.ngayBatDau);
            document.getElementById('cp_end').value = formatDate(p.ngayKetThuc);
            const startNative = document.getElementById('cp_start_native');
            const endNative = document.getElementById('cp_end_native');
            if (startNative) startNative.value = p.ngayBatDau;
            if (endNative) endNative.value = p.ngayKetThuc;
            document.getElementById('cp_dautu').value = p.mucDauTu;
            document.getElementById('cp_trangthai').value = p.trangThai;
            document.getElementById('cp_tiendo').value = p.tienDo;
            document.getElementById('cp_image_url').value = p.image || '';
            const prev = document.getElementById('cp_preview');
            if (p.image){ prev.src = p.image; prev.style.display = 'block'; }
            document.getElementById('createProjectForm').setAttribute('data-edit-id', id);
            // Offer to add attachments while editing
            const form = document.getElementById('createProjectForm');
            const attachBtnId = 'btn_add_attachments';
            if (!document.getElementById(attachBtnId)){
                const actions = document.getElementById('formActionButtons');
                const btn = document.createElement('button');
                btn.id = attachBtnId;
                btn.type = 'button';
                btn.textContent = '+ Thêm tài liệu đính kèm';
                btn.style.cssText = 'padding:8px 12px; border:none; background: linear-gradient(135deg, #10b981, #059669); border-radius:8px; cursor:pointer; color:#ffffff; margin-right:auto;';
                const container = document.getElementById('formActions');
                if (container){ container.insertBefore(btn, actions); }
                btn.addEventListener('click', () => openAttachmentDialog(id));
            }
            // In edit mode, allow changing status
            const statusEl = document.getElementById('cp_trangthai');
            if (statusEl){ statusEl.disabled = false; }
        }
        function confirmDeleteChosen(){
            const sel = document.getElementById('del_select');
            if (!sel) return;
            window.__selectedProjectId = sel.value;
            document.getElementById('deleteChooser').remove();
            deleteLatestProject();
        }

        // Toggle settings menu by click so it won't disappear while moving mouse
        function toggleSettingsMenu(e){
            e.stopPropagation();
            const wrapper = document.getElementById('settingsWrapper');
            wrapper.classList.toggle('open');
        }
        // Close when clicking outside
        document.addEventListener('click', function(){
            const wrapper = document.getElementById('settingsWrapper');
            if (wrapper) wrapper.classList.remove('open');
        });

        // Hiển thị tất cả dự án (từ projectDetailsById) dưới dạng danh sách chi tiết
        function showAllProjects(e){
            if (e) e.preventDefault();
            
            // Kiểm tra và cập nhật trạng thái dựa trên lịch sử trước khi hiển thị
            updateProjectStatusFromAudit();
            
            const isPrivileged = canCreateOrEdit(); // admin or manager
            const allIds = Object.keys(projectDetailsById);
            const ids = isPrivileged
                ? allIds
                : allIds.filter(id => canViewProject(projectDetailsById[id]));
            if (!ids.length){
                showNotification(isPrivileged ? 'Chưa có dự án nào' : 'Bạn chưa được gán vào dự án nào');
                return;
            }
            const userRole = window.__currentRole || 'guest';
            const isEmployee = userRole === 'employee';
            const content = ids.map((id, idx) => {
                const p = projectDetailsById[id];
                const statusClass = p.trangThai === 'Đã hoàn thành' ? 'status-completed' : (p.trangThai === 'Chờ phê duyệt' ? 'status-pending' : 'status-active');
                const isPending = p.trangThai === 'Chờ phê duyệt';
                const progressHtml = isPending
                    ? `<div class="pending-note" style="margin:8px 0 0; padding:8px 12px; background:#fff7ed; color:#b45309; border:1px solid #fde68a; border-radius:8px; font-size:14px;">Dự án đang chờ duyệt. Tiến độ sẽ hiển thị sau khi được duyệt.</div>`
                    : `<div class="project-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${Math.max(0, Math.min(100, p.tienDo||0))}%; height:100%;"></div>
                        </div>
                        <div class="progress-text">Hoàn thành ${Math.max(0, Math.min(100, p.tienDo||0))}%</div>
                    </div>`;
                const historyBtn = isEmployee ? `<button onclick=\"viewProjectHistoryFor('${id}')\" style=\"padding: 10px 12px; margin-right:8px; background: white; color: #2d3748; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;\">📜 Lịch sử</button>` : '';
                return `
                    <div class="project-item" style="margin-bottom:12px;">
                        <div class="project-header">
                            <div class="project-name">
                                Dự án ${idx+1}: ${p.ten}
                                <div class="project-status ${statusClass}">${p.trangThai}</div>
                            </div>
                            ${p.image ? `<img src="${p.image}" alt="${p.ten}" class="project-image">` : ''}
                        </div>
                        ${progressHtml}
                        <div style="margin-top: 12px; text-align: right;">
                            ${historyBtn}
                            <button onclick="showProjectDetails('${id}')" style="padding: 10px 16px; background: white; color: #838994; border: 2px solid #2d3748; border-radius: 8px; cursor: pointer; font-weight: 500;">🔎 Xem chi tiết</button>
                        </div>
                    </div>`;
            }).join('');

            const modal = `
                <div id="allProjectsModal" style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:3000; display:flex; align-items:center; justify-content:center;">
                    <div style="background:#fff; border-radius:16px; width:96%; max-width:1100px; max-height:88vh; overflow:auto; padding:24px; color:#2d3748;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h3 style="margin:0;">${isPrivileged ? 'Tất cả dự án' : 'Dự án của tôi'}</h3>
                            <button onclick="document.getElementById('allProjectsModal').remove()" style="padding:8px 12px; border:none; border-radius:8px; background:#667eea; color:#fff; cursor: pointer; font-size: 16px;">Đóng</button>
                        </div>
                        <div class="project-list" style="gap:16px;">
                            ${content}
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
    </script>
</body>
</html>